import csv
import numpy as np
from sklearn.svm import SVC
import matplotlib.pyplot as plt
import matplotlib as mpl
from matplotlib.patches import Circle
import pandas as pd
import json

nodedict={}
typedict={}
edge=set()
f = pd.read_json('/mnt/datasets/zeyu/HIN_DATA/1_1.json')
length = len(f["md5"])

for i in range(length):
    name = f['md5'][i]
    if(name not in nodedict):
        nodedict[name] = len(nodedict)
        typedict[nodedict[name]] = "pefile"
    ex = f["exports"][i]
    for exp in ex:
        if "@" in  exp:
            continue
        if(exp not in nodedict):
            nodedict[exp] = len(nodedict)
            typedict[nodedict[exp]] = "export"
        edge.add((nodedict[name],nodedict[exp]))
        edge.add((nodedict[exp],nodedict[name]))

    imports = f["imports"][i]
    for api in imports:
        if (api not in nodedict):
            nodedict[api] = len(nodedict)
            typedict[nodedict[api]] = "imports"
        edge.add((nodedict[name], nodedict[api]))
        edge.add((nodedict[api], nodedict[name]))

    for ch in f["header"]:
        for char in ch["coff"]["characteristics"]:
            if (char not in nodedict):
                nodedict[char] = len(nodedict)
                typedict[nodedict[char]] = "characteristics"
            edge.add((nodedict[name], nodedict[char]))
            edge.add((nodedict[char], nodedict[name]))

    for ma in f["header"]:
        d = ma["optional"]["dll_characteristics"]
        for dll in d:
            if (dll not in nodedict):
                nodedict[dll] = len(nodedict)
                typedict[nodedict[dll]] = "dll_characteristics"
            edge.add((nodedict[name], nodedict[dll]))
            edge.add((nodedict[dll], nodedict[name]))

    for files_sections in f["section"]:
        file_sections = files_sections["sections"]
        for seciton in file_sections:
            na = seciton['name']
            if (na not in nodedict):
                nodedict[na] = len(nodedict)
                typedict[nodedict[na]] = "sections"
            edge.add((nodedict[name], nodedict[na]))
            edge.add((nodedict[na], nodedict[name]))

with open('/mnt/datasets/zeyu/HIN_DATA/graph.node','w',newline='')as f:
    f_csv = csv.writer(f)
    for key,value in nodedict.items():
        f_csv.writerow([value,typedict[value],key])
with open('/mnt/datasets/zeyu/HIN_DATA/graph.edge','w',newline='')as f:
    f_csv = csv.writer(f)
    for e in edge:
        f_csv.writerow([e[0],e[1]])